# PR Checks - Lint, Type Check, and Test
# Runs on all PRs to main and pushes to main
# All checks must pass before merge (enforced by branch protection)

name: PR Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.10

      - name: Install dependencies
        run: uv sync --dev

      - name: Run Ruff linter
        run: uv run ruff check . --output-format=github

      - name: Run Ruff formatter check
        run: uv run ruff format --check --diff .

  type-check:
    name: Type Check (Mypy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.10

      - name: Install dependencies
        run: uv sync --dev

      - name: Run Mypy on app/
        run: uv run mypy app/ --config-file=pyproject.toml

  test:
    name: Test (Pytest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.10

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests
        run: uv run pytest --tb=short -q

  security:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.10

      - name: Install dependencies
        run: uv sync --dev

      - name: Run security checks (Ruff S rules)
        run: uv run ruff check . --select=S --output-format=github

  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    # Only run on pull requests, not pushes
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Review this PR for:
            1. Code quality and best practices
            2. Potential bugs or logic errors
            3. Security vulnerabilities
            4. Test coverage adequacy
            5. Documentation completeness
            6. Adherence to project conventions (PEP 8, type hints, Google-style docstrings)

            Be constructive and specific. Flag blocking issues vs suggestions.
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # Gate job - all checks must pass
  all-checks-pass:
    name: All Checks Pass
    needs: [lint, type-check, test, security, claude-review]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.type-check.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]]; then
            echo "One or more checks failed"
            exit 1
          fi
          # claude-review is skipped on pushes (only runs on PRs)
          if [[ "${{ github.event_name }}" == "pull_request" ]] && \
             [[ "${{ needs.claude-review.result }}" != "success" ]]; then
            echo "Claude Code Review failed"
            exit 1
          fi
          echo "All checks passed!"
